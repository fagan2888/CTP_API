# CTP_API
#### from Thread to real-time update and output future quotes
  
#### 2020/04/12 22:06(第一次更新)
  
### 写在前面的话
其实要说平时自己有没有很经常用到线程这个东西，答案是否定的，可能我处理的数据量还不够大吧哈哈哈……还有一点，据说python的多线程是伪并行（大家可以看看这篇文章：[从伪并行的 Python 多线程说起](https://segmentfault.com/a/1190000013646127)）？不过这不影响今天要讲的内容，开一个线程只是想让大家熟悉一下开线程这个过程，知道有多线程这个东西可以来优化我们的程序（其实不应该叫优化，因为本来多线程就很常见……），而我只是不想我的python在实时更新期货行情的时候，一直显示它在运行……（强迫症了hhh……）  
  
### CTP程序化交易过程
讲怎么写线程之前，我们先来了解一下怎么实时获取期货、期权的行情（你可能会想着去什么行情网站上搞什么爬虫啊之类的，我不知道你有没有这种想法反正我是很烦爬虫的）。其实网路上有蛮多接口的，可能最常用的就是CTP接口吧。下面是我之前写的一篇CTP接口介绍，参考自[CTP程序化交易入门系列之一：准备](https://blog.csdn.net/pjjing/article/details/90381795)，博主的介绍非常详细，我只是做一个口水话的summary，如果大家还有不懂的，可以把这个入门系列的文章都看一遍~  
  
#### 一、引入
现在假设你是一位已经在XX期货公司开户了的个人交易员，你想要在家里进行交易，但你又已经开发了一套自己的程序化交易系统，你不想用第三方厂商提供的交易软件，如快期之类的进行下单操作，这个时候，你就需要在你的交易系统里，调用到CTP接口，才能够接入到期货公司的柜台系统，进行下单操作。  
  
#### 二、什么是CTP接口？
依据国内监管要求，客户无法直连交易所系统，中间必须经过期货公司（Broker）的系统，这便是上文提到的期货公司的柜台系统。而接入到期货公司的柜台系统所用到的接口，就是CTP接口，它是由上海期货推出的一套可供程序调用的交易接口，就好比是官方给程序化交易提供了的一个专门的业务窗口。  
  
![CTP接口](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%870.png)
  
#### 三、怎么用CTP接口接入到柜台系统？（过程与所需信息）
CTP接口分为两类：行情与交易。如果你只是想要获取行情的话，你只需要使用行情接口以及对应的函数即可。具体的步骤和过程如下图所示：  
  
![接入柜台系统](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%871.png)
  
解释一下上图，实际上可能比较疑惑的就是api与spi。api实例包含所有的请求函数，而spi则是将CTP接口回应我们请求信息的所有消息，回调出来的实例。api与spi实例的函数基本上都是一一对应的，如上图中的ReqUserLogin和OnRspUserLogin就分别是api的登录请求和spi的登录响应回调函数。一般spi实例都是继承了原有的CThostFtdcTraderSpi父类，然后我们在其基础上进行改写，比如说，在OnFrontConnected函数中我们回调到CTP已经成功地创建了我们在Init函数中发起的链接，此时执行我们改写的spi实例，进行ReqUserLogin，登录的信息包括：  
  
- BrokerID：期商编码，是指期货公司在CTP系统上的编码，为四位数。
- UserID：投资者代码，是指客户在CTP系统上的唯一ID，在期货公司开户后由公司分配得到。
- Password：开户时设置的密码，首次登录CTP系统需要修改密码，可在快期客户端上修改。
  
当我们回调到登录成功的响应后，就开始订阅行情，当我们回调到行情订阅成功的响应后，就开始输出我们想要的信息，这就是整个行情获取的过程，如下图所示：  
  
![订阅行情](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%872.png)
    
#### 四、如果我要用交易接口咋办？
对于需要用到CTP 接口自主开发交易程序进行交易的投资者，必须要通过穿透式监管<sup>[1]</sup>，这时，就需要向开户期货公司报备AppID，在通过申请后才能获取到AuthCode：  
  
- AppID：客户终端软件代码（客户自己命名，监控中心有给出命名规范）。
- AuthCode：客户终端软件认证码（AppID申请通过后，期货公司会发送AuthCode给客户）。
  
上述两个信息，是在你程序请求登录时（OnFrontConnected()函数里）必须要填写的两个信息，否则无法登录柜台系统进行实盘交易。除此之外，还有一些登录的逻辑需要进行改写，在这里就不多加以赘述了，感兴趣的话可以参考[《什么是穿透式监管，需要投资者做什么？》](https://blog.csdn.net/pjjing/article/details/90141906)。  
  
[1]穿透式监管：简单地说就是监控中心为了方便监管，需采集所有通过期货公司入场交易的客户的本地终端信息。也就是说，如果你使用了快期这类的第三方交易软件，在使用的过程中，第三方厂商自然会把你的AppID等信息报备给期货公司，你不需要做任何处理。但是如果你是自主开发了程序化交易系统，你得自主地找你开户的期货公司报备你的AppID等信息，然后等申请通过后，期货公司会发给你AuthCode，之后你才能实现在家进行程序化交易。  
  
### 实时更新期货行情
为什么要开一个线程？因为我想24h都在输出行情，原本CTP接口的调用就是异步返回的过程，所以其实你只要一初始化（mduserapi.Init()），不把接口释放掉，它就是在实时更新的。而这里开线程，我是想每隔10s就输出一次期货行情到我的Excel里，方便我其他程序对这个Excel进行其他操作（其实这是当时实习主管的要求，我本来还很想探索一下跨进程间的通信问题，但她说太麻烦了，加上他们的程序也是基于一套Excel表格在写的，所以就让我输出成Excel……）。写法很简单，一个
```Python
while True：
time.sleep(10)
output.to_excel(path)
```
就可以了，当然期间你还需要考虑一个问题，为了防止你的Excel正在被读取和这边的实时更新输出产生冲突，你得加一个except IOError。  
  
![while循环体](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%873.png)
  
所以整个线程的书写过程非常地简单，如果不知道怎么写线程的话可以去百度一下，我用的是类的方法（面向对象也得看看哇，会python不能说不用类就可以不会的……）。
现在，我的期货行情确实是可以实时输出了，但我要怎么停下来呢？几番百度无果后，决定直接把这个线程给掐掉（有人还说故意制造一个错误让程序报错停掉……太暴力了，我采取的是这篇文章中的做法：[python终止线程](https://blog.csdn.net/x18835129278/article/details/90048180)）。不过你在把这个线程掐掉以前，别忘了，你还有一个mduserapi还没有释放掉，如果不释放的话，它就还是会一直返回行情，所以我在线程的那个类上又额外封装了一个类，一个函数用来开启线程，一个函数用来释放mduserapi和掐断线程。  
  
### 写在后面的话
整个过程并不是非常地困难，我故意弄了一个df（df是随着CTP接口返回的行情在不断更新的），就是想告诉大家，针对这个实时更新的df，你还可以做很多操作，你甚至可以实时地绘制k线图，或者自动更新到你的Excel表里做些其他复杂的运算……但这仅仅是行情接口而已，你们可以到simnow官网上注册账号，拿到你所需的所有登录接口要用到的信息，包括前置地址。至于交易接口，它的类写法还有点不同，可以参考[CTP程序化交易入门系列之四：行情订阅常见问题解答](https://blog.csdn.net/pjjing/article/details/100532276)这位博主所有系列博客的内容。诶讲了这么多……我还是乖乖地学C++好了，不然要被时代淘汰的吧？毕竟伪并行确实是个问题，而且CTP接口本来就是用C++写的，即便python很方便，在基于以前的东西上要再做发展，还是得学C++呐……  
  
### 结果展示
  
![与交易软件行情对比](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%874.png)
  
![与实时更新Df对比](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%875.png)
  
![与输出Excel对比](https://github.com/yuba316/CTP_API/blob/master/%E5%9B%BE%E7%89%87/%E5%9B%BE%E7%89%876.png)
